name: æ„å»ºå‘å¸ƒç‰ˆæœ¬ (PyInstaller)

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: ä¼˜åŒ–PyInstalleré…ç½®
      run: |
        # ç¡®ä¿specæ–‡ä»¶å­˜åœ¨å¹¶åŒ…å«ä¼˜åŒ–é…ç½®
        if (!(Test-Path build_pyinstaller.spec)) {
          Write-Error "build_pyinstaller.spec not found"
          exit 1
        }
      shell: pwsh
    
    - name: ä½¿ç”¨PyInstalleræ„å»º
      run: |
        pyinstaller build_pyinstaller.spec --clean --noconfirm
      shell: pwsh
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        cd dist
        Compress-Archive -Path stt -DestinationPath stt-windows-x64.zip
    
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: get_version
      run: |
        $version = (Get-Content version.json | ConvertFrom-Json).version
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: stt-windows-pyinstaller
        path: dist/stt-windows-x64.zip
        retention-days: 30
    
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/stt-windows-x64.zip
        body: |
          ## ğŸ“¦ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}
          
          ### æ„å»ºæ–¹å¼
          - ä½¿ç”¨ PyInstaller æ‰“åŒ…
          - Python 3.11
          - Windows x64
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½ `stt-windows-x64.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `stt.exe` å¯åŠ¨ç¨‹åº
          
          ### æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶
          - è¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

