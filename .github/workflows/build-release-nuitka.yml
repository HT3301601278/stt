name: æ„å»ºå‘å¸ƒç‰ˆæœ¬ (Nuitka)

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka ordered-set zstandard
    
    - name: å®‰è£…MSVCç¼–è¯‘å™¨
      uses: microsoft/setup-msbuild@v2
    
    - name: ä½¿ç”¨Nuitkaæ„å»º
      run: |
        python -m nuitka `
          --standalone `
          --windows-console-mode=force `
          --assume-yes-for-downloads `
          --enable-plugin=anti-bloat `
          --include-package=torch `
          --include-package=faster_whisper `
          --include-package=flask `
          --include-package=gevent `
          --include-package=stslib `
          --include-data-dir=templates=templates `
          --include-data-dir=static=static `
          --include-data-file=set.ini=set.ini `
          --include-data-file=version.json=version.json `
          --nofollow-import-to=matplotlib `
          --nofollow-import-to=scipy `
          --nofollow-import-to=pandas `
          --nofollow-import-to=numpy.distutils `
          --nofollow-import-to=jupyter `
          --nofollow-import-to=notebook `
          --nofollow-import-to=IPython `
          --nofollow-import-to=tkinter `
          --nofollow-import-to=PyQt5 `
          --nofollow-import-to=PyQt6 `
          --nofollow-import-to=PySide2 `
          --nofollow-import-to=PySide6 `
          --nofollow-import-to=pytest `
          --nofollow-import-to=unittest `
          --nofollow-import-to=setuptools `
          --nofollow-import-to=pip `
          --nofollow-import-to=wheel `
          --nofollow-import-to=distutils `
          --remove-output `
          --output-dir=build `
          start.py
    
    - name: åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
      run: |
        New-Item -ItemType Directory -Force -Path dist/stt
        # å¤åˆ¶Nuitkaç”Ÿæˆçš„standaloneæ–‡ä»¶å¤¹å†…å®¹
        Copy-Item -Recurse build/start.dist/* dist/stt/
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        New-Item -ItemType Directory -Force -Path dist/stt/models
        New-Item -ItemType Directory -Force -Path dist/stt/upload
        # å¤åˆ¶æ–‡æ¡£æ–‡ä»¶
        if (Test-Path README.md) { Copy-Item README.md dist/stt/ }
        if (Test-Path LICENSE) { Copy-Item LICENSE dist/stt/ }
      shell: pwsh
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        cd dist
        Compress-Archive -Path stt -DestinationPath stt-windows-x64-nuitka.zip
    
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: get_version
      run: |
        $version = (Get-Content version.json | ConvertFrom-Json).version
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: stt-windows-nuitka
        path: dist/stt-windows-x64-nuitka.zip
        retention-days: 30
    
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/stt-windows-x64-nuitka.zip
        body: |
          ## ğŸ“¦ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}
          
          ### æ„å»ºæ–¹å¼
          - ä½¿ç”¨ Nuitka ç¼–è¯‘æ‰“åŒ…
          - Python 3.11
          - Windows x64
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½ `stt-windows-x64-nuitka.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `stt.exe` å¯åŠ¨ç¨‹åº
          
          ### æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶
          - è¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
          - Nuitkaç‰ˆæœ¬æ€§èƒ½æ›´ä¼˜
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
